{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4 text-center"><i class="bi bi-clipboard-pulse"></i> Dashboard Analisis Luka</h2>
    <div id="scan-list" class="row g-4"></div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script>
  // Konfigurasi dari Flask/.env
  const firebaseConfig = {
    apiKey: "{{ FIREBASE_API_KEY }}",
    authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
    projectId: "{{ FIREBASE_PROJECT_ID }}",
    storageBucket: "{{ FIREBASE_STORAGE_BUCKET }}",
    messagingSenderId: "{{ FIREBASE_MESSAGING_SENDER_ID }}",
    appId: "{{ FIREBASE_APP_ID }}",
    measurementId: "{{ FIREBASE_MEASUREMENT_ID }}"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Ambil data scan yang belum dianalisis
  function loadScans() {
    db.collection('scans').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      const scanList = document.getElementById('scan-list');
      scanList.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        // Tampilkan hanya yang statusnya "Menunggu Analisis"
        if (data.status === 'Menunggu Analisis') {
          const card = document.createElement('div');
          card.className = 'col-md-6';
          card.innerHTML = `
            <div class="card shadow-sm h-100">
              <img src="${data.imageUrl}" class="card-img-top" alt="Luka" style="max-height:300px;object-fit:contain;">
              <div class="card-body">
                <h5 class="card-title">Analisis Luka</h5>
                <form class="analyze-form" data-id="${doc.id}">
                  <div class="mb-2">
                    <label class="form-label">Pilih Hasil Analisis:</label>
                    <select class="form-select" name="result" required>
                      <option value="">-- Pilih --</option>
                      <option value="Rujuk ke Rumah Sakit">Rujuk ke Rumah Sakit</option>
                      <option value="Rawat di Rumah">Rawat di Rumah</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Komentar / Catatan:</label>
                    <textarea class="form-control" name="comment" rows="2" placeholder="Masukkan komentar atau saran..." required></textarea>
                  </div>
                  <button type="submit" class="btn btn-success w-100">Kirim Analisis</button>
                  <div class="analyze-message mt-2 text-center"></div>
                </form>
              </div>
              <div class="card-footer text-muted text-end" style="font-size:0.9em;">
                Diupload: ${data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : '-'}
              </div>
            </div>
          `;
          scanList.appendChild(card);
        }
      });

      // Tambahkan event listener ke semua form analisis
      document.querySelectorAll('.analyze-form').forEach(form => {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const docId = this.getAttribute('data-id');
          const result = this.result.value;
          const comment = this.comment.value;
          const msgDiv = this.querySelector('.analyze-message');
          msgDiv.innerHTML = '<span class="text-info">Menyimpan analisis...</span>';
          db.collection('scans').doc(docId).update({
            status: result,
            comment: comment,
            analyzedAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            msgDiv.innerHTML = '<span class="text-success">Analisis berhasil disimpan!</span>';
            setTimeout(() => {
              this.closest('.col-md-6').remove();
            }, 1200);
          }).catch(err => {
            msgDiv.innerHTML = '<span class="text-danger">Gagal menyimpan: ' + err.message + '</span>';
          });
        });
      });
    });
  }

  document.addEventListener('DOMContentLoaded', loadScans);
</script>
{% endblock %}