{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="card-title mb-3 text-center">Scan Luka Diabetes</h2>
                    <form id="scan-form" autocomplete="off">
                        <div class="mb-3">
                            <label for="file" class="form-label">Unggah Foto Luka</label>
                            <input class="form-control" type="file" name="file" id="file" accept="image/*" required>
                        </div>
                        <!-- Preview gambar -->
                        <div class="mb-3 text-center">
                            <img id="preview-img" src="#" alt="Preview Gambar" style="display:none; max-width: 100%; max-height: 250px; border-radius: 12px; box-shadow: 0 2px 8px rgba(21,114,161,0.08);" />
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Kirim ke Nakes</button>
                        <div id="scan-message" class="mt-3 text-center"></div>
                    </form>
                    <div class="alert alert-warning mt-4" role="alert">
                        <i class="bi bi-hourglass-split"></i>
                        Hasil analisis akan muncul setelah diperiksa oleh tenaga kesehatan.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  // Konfigurasi dari Flask/.env
  const firebaseConfig = {
    apiKey: "{{ FIREBASE_API_KEY }}",
    authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
    projectId: "{{ FIREBASE_PROJECT_ID }}",
    storageBucket: "{{ FIREBASE_STORAGE_BUCKET }}",
    messagingSenderId: "{{ FIREBASE_MESSAGING_SENDER_ID }}",
    appId: "{{ FIREBASE_APP_ID }}",
    measurementId: "{{ FIREBASE_MEASUREMENT_ID }}"
  };
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();
  const db = firebase.firestore();

  // Preview gambar sebelum upload
  document.getElementById('file').addEventListener('change', function(e) {
    const preview = document.getElementById('preview-img');
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        preview.src = ev.target.result;
        preview.style.display = "block";
      }
      reader.readAsDataURL(file);
    } else {
      preview.src = "#";
      preview.style.display = "none";
    }
  });

  document.getElementById('scan-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('file');
    const messageDiv = document.getElementById('scan-message');
    const file = fileInput.files[0];
    if (!file) return;

    // Buat nama unik untuk file
    const fileName = 'scan_' + Date.now() + '_' + file.name;
    const storageRef = storage.ref('scans/' + fileName);

    messageDiv.innerHTML = '<span class="text-info">Mengunggah gambar...</span>';

    storageRef.put(file).then(snapshot => {
      return snapshot.ref.getDownloadURL();
    }).then(url => {
      // Simpan data ke Firestore
      return db.collection('scans').add({
        imageUrl: url,
        status: 'Menunggu Analisis',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }).then(() => {
      messageDiv.innerHTML = '<span class="text-success">Gambar berhasil dikirim! Silakan tunggu analisis dari tenaga kesehatan.</span>';
      fileInput.value = '';
      document.getElementById('preview-img').style.display = "none";
    }).catch(err => {
      messageDiv.innerHTML = '<span class="text-danger">Gagal mengirim gambar: ' + err.message + '</span>';
    });
  });
</script>
{% endblock %}